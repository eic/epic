<!-- SPDX-License-Identifier: LGPL-3.0-or-later -->
<!-- Copyright (C) 2022 - 2025 Sylvester Joosten, Wouter Deconinck, Shujie Li, Aditya Yalavatti, Sam Henry -->

<lccdd>
  <define>
    <comment>
         This version is for the flat_OB geometry - a more accurate model with carbon fiber braces to
         reproduce the peaks in the material thickness scan.

         Presentation: https://indico.bnl.gov/event/29542
    </comment>

    <constant name="SiBarrelMod1_rmin" value="SiBarrel1_rmin - 0.5*cm" /> <!-- 26.5 cm-->
    <constant name="SiBarrelMod2_rmin" value="SiBarrel2_rmin - 6*mm" /> <!-- 41.4 cm -->

    <constant name="SiBarrelMod_angle" value="SiBarrel_angle" /> <!-- pi/4 or 45 deg -->
    <constant name="SiBarrelMod_dz" value="SiBarrel_dz" /> <!-- 2 cm -->

    <constant name="SiBarrelSensor_thickness" value="40*um" />
    <constant name="SiBarrelSiliconGap_width" value="1*mm" />

    <constant name="SiBarrelMod1Service_thickness" value="0.07875*mm" />
    <constant name="SiBarrelMod2Service_thickness" value="0.066045*mm" />
    <constant name="SiBarrelMod1Frame_thickness" value="0.06*mm" />
    <constant name="SiBarrelMod2Frame_thickness" value="0.12*mm" />
    <constant name="SiBarrelMod1Frame_height" value="0.8*cm" />
    <constant name="SiBarrelMod2Frame_height" value="0.8*cm" />
    <constant name="SiBarrelStave1_width" value="3.8*cm" />
    <constant name="SiBarrelStave2_width" value="3.8*cm" /> <!--UPDATED from 3.9 to 3.8-->


    <constant name="SiBarrelMod1_length"        value="2 * SiBarrelMod1_rmin / tan(SiBarrelMod_angle) - SiBarrel_dz - 7*mm"/> <!--UPDATED from SiBarrel_dz to SiBarrel_dz -12*mm (2*26.5/1 -2-0.7 = 50.3cm)-->

    <comment> 84cm=2*42cm is the engineer max </comment>
    <constant name="SiBarrelMod2_length" value="84*cm - 4.7*cm" /> <!--UPDATED from 84*cm to 84*cm - 4.7*cm = 79.3cm-->

    <constant name="SiBarrelLayer1_length" value="SiBarrelMod1_length + 1*um" />
    <constant name="SiBarrelLayer2_length" value="SiBarrelMod2_length + 1*um" />
    <constant name="SiBarrelEnvelope_length" value="SiBarrelLayer2_length + 1*um" />

    <constant name="SiBarrelLayer_thickness" value="3.0*cm" />
    <constant name="SiBarrelLayer1_rmin" value="SiBarrelMod1_rmin - 6*mm " /> <!--UPDATED from SiBarrelMod1_rmin to SiBarrelMod1_rmin -6*mm -->
    <constant name="SiBarrelLayer1_rmax" value="SiBarrelLayer1_rmin + SiBarrelLayer_thickness" />
    <constant name="SiBarrelLayer2_rmin" value="SiBarrelMod2_rmin " />  <!--Problem child SiBarrelMod2_rmin-10*mm -->
    <constant name="SiBarrelLayer2_rmax" value="SiBarrelLayer2_rmin + SiBarrelLayer_thickness" />

    <constant name="SiBarrelStave1_count" value="46" />
    <constant name="SiBarrelStave2_count" value="70" />
    <constant name="SiBarrel1_radius_castellation" value="6*mm" />
    <constant name="SiBarrel2_radius_castellation" value="6*mm" />
    <constant name="SiBarrel1_radius_offset" value="0*mm" /> <!--from 5.5*mm to 0*mm -->
    <constant name="SiBarrel2_radius_offset" value="9.5*mm" /> <!--Problem child 0mm -->



    <constant name="SiBarrelBrace_width" value="10*mm" />
    <constant name="SiBarrelBrace_thickness" value="2*mm" />
    <constant name="SiBarrelBrace_StaveWidthFraction" value="0.9" />
    <constant name="SiBarrelBrace_Position_X" value="-1*mm" />

    <constant name="SiBarrel1_Brace0_Position_Y" value="0.0" />
    <constant name="SiBarrel1_Brace1_Position_Y" value="13.20*cm" />
    <constant name="SiBarrel1_Brace2_Position_Y" value="24.0*cm" />
    <constant name="SiBarrel2_Brace0_Position_Y" value="0.0" />
    <constant name="SiBarrel2_Brace1_Position_Y" value="11.3*cm" />
    <constant name="SiBarrel2_Brace2_Position_Y" value="21.6*cm" />
    <constant name="SiBarrel2_Brace3_Position_Y" value="32.8*cm" />
    <constant name="SiBarrel2_Brace4_Position_Y" value="39.5*cm" /> <!--UPDATED from 41.0 cm to 39.5 cm -->



  </define>

  <detectors>
    <documentation level="5">
      ### Actual detectors
    </documentation>
    <detector
      id="TrackerBarrel_0_ID"
      name="SagittaSiBarrel"
      type="epic_TrackerBarrel"
      readout="SiBarrelHits"
      insideTrackingVolume="true">
      <type_flags type="DetType_TRACKER + DetType_BARREL" />
      <dimensions
        rmin="SiBarrelLayer1_rmin"
        rmax="SiBarrelLayer1_rmax"
        length="SiBarrelLayer1_length" />
      <comment>Silicon Barrel Modules</comment>
      <module name="Module1" vis="TrackerLayerVis">
        <module_component name="Frame"
          material="CarbonFiber"
          sensitive="false"
          width="SiBarrelStave1_width"
          length="SiBarrelMod1_length"
          thickness="SiBarrelMod1Frame_thickness"
          vis="TrackerSupportVis" >
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel1_Brace0_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel1_Brace1_Position_Y" z=" - SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel1_Brace1_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel1_Brace2_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel1_Brace2_Position_Y" z=" - SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Service"
          material="Kapton"
          sensitive="false"
          width="SiBarrelStave1_width"
          length="SiBarrelMod1_length"
          thickness="SiBarrelMod1Service_thickness"
          vis="TrackerLayerVis"/>

        <module_component name="Silicon_right"
          material="Silicon"
          sensitive="true"
          width="SiBarrelStave1_width/2 - SiBarrelSiliconGap_width/2"
          length="SiBarrelMod1_length"
          thickness="SiBarrelSensor_thickness*2.7"
          vis="TrackerLayerVis"> <!-- multiply thickness by 2.7 this increases thickness by 0.00034 -->
          <position x="SiBarrelSiliconGap_width/4 + SiBarrelStave1_width/4" y="0" z="0" />
        </module_component>
        <module_component name="Silicon_center"
          material="Silicon"
          sensitive="false"
          width="SiBarrelSiliconGap_width"
          length="SiBarrelMod1_length"
          thickness="SiBarrelSensor_thickness*2.7"
          vis="TrackerLayerVis"> <!-- multiply thickness by 2.7 this increases thickness by 0.00034 -->
        <position x="0" y="0" z="-SiBarrelSensor_thickness*2.7" />
        </module_component>
        <module_component name="Silicon_left"
          material="Silicon"
          sensitive="true"
          width="SiBarrelStave1_width/2 - SiBarrelSiliconGap_width/2"
          length="SiBarrelMod1_length"
          thickness="SiBarrelSensor_thickness*2.7"
          vis="TrackerLayerVis"> <!-- multiply thickness by 2.7 this increases thickness by 0.00034 -->
        <position x="-SiBarrelSiliconGap_width/4 - SiBarrelStave1_width/4" y="0" z="-SiBarrelSensor_thickness*2.7" />
        </module_component>


      </module>
      <comment> Layers composed of many arrayed modules </comment>
      <layer module="Module1" id="1" vis="TrackerLayerVis">
        <barrel_envelope
          inner_r="SiBarrelLayer1_rmin-0.5*mm"
          outer_r="SiBarrelLayer1_rmax"
          z_length="SiBarrelLayer1_length" />
        <layer_material surface="inner" binning="binPhi,binZ" bins0="SiBarrelStave1_count"
          bins1="100" />
        <layer_material surface="outer" binning="binPhi,binZ" bins0="SiBarrelStave1_count"
          bins1="100" />
        <comment>
          phi0 : Starting phi of first module.
          phi_tilt : Phi tilt of a module.
          rc : Radius of the module center.
          nphi : Number of modules in phi.
          rphi_dr : The delta radius of every other module.
          z0 : Z position of first module in phi.
          nz : Number of modules to place in z.
          dr : Radial displacement parameter, of every other module.
        </comment>
        <rphi_layout phi_tilt="0.0" nphi="SiBarrelStave1_count" phi0="0.0"
          rc="SiBarrelMod1_rmin+SiBarrel1_radius_offset" dr="SiBarrel1_radius_castellation" />
        <z_layout dr="0.0 * mm" z0="0.0 * mm" nz="1" />
      </layer>
    </detector>
    <documentation level="5">
      ### Actual detectors
    </documentation>
    <detector
      id="TrackerBarrel_1_ID"
      name="OuterSiBarrel"
      type="epic_TrackerBarrel"
      readout="SiBarrelHits"
      insideTrackingVolume="true">
      <type_flags type="DetType_TRACKER + DetType_BARREL" />
      <dimensions
        rmin="SiBarrelLayer2_rmin"
        rmax="SiBarrelLayer2_rmax"
        length="SiBarrelLayer2_length" />
      <comment>Silicon Barrel Modules</comment>
      <module name="Module1" vis="TrackerLayerVis">

        <module_component name="Frame"
          material="CarbonFiber"
          sensitive="false"
          width="SiBarrelStave2_width"
          length="SiBarrelMod2_length"
          thickness="SiBarrelMod2Frame_thickness"
          vis="TrackerSupportVis" />

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace0_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace1_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace1_Position_Y" z=" - SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace2_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace2_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace3_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace3_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace4_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace4_Position_Y" z="- SiBarrelBrace_thickness" />
        </module_component>

      <module_component name="Service"
          material="Kapton"
          sensitive="false"
          width="SiBarrelStave2_width"
          length="SiBarrelMod2_length"
          thickness="SiBarrelMod2Service_thickness"
          vis="TrackerLayerVis" /> <!-- multiply thickness by 0.17 and change from aluminum to Kapton -->

        <module_component name="Silicon_right"
          material="Silicon"
          sensitive="true"
          width="SiBarrelStave2_width/2 - SiBarrelSiliconGap_width/2"
          length="SiBarrelMod2_length"
          thickness="SiBarrelSensor_thickness*2.7"
          vis="TrackerLayerVis"> <!-- multiply thickness by 2.7 this increases thickness by 0.00034 -->
          <position x="SiBarrelSiliconGap_width/4 + SiBarrelStave2_width/4" y="0" z="0" />
        </module_component>
        <module_component name="Silicon_center"
          material="Silicon"
          sensitive="false"
          width="SiBarrelSiliconGap_width"
          length="SiBarrelMod2_length"
          thickness="SiBarrelSensor_thickness*2.7"
          vis="TrackerLayerVis"> <!-- multiply thickness by 2.7 this increases thickness by 0.00034 -->
       <position x="0" y="0" z="-SiBarrelSensor_thickness*2.7" />
        </module_component>
        <module_component name="Silicon_left"
          material="Silicon"
          sensitive="true"
          width="SiBarrelStave2_width/2 - SiBarrelSiliconGap_width/2"
          length="SiBarrelMod2_length"
          thickness="SiBarrelSensor_thickness*2.7"
          vis="TrackerLayerVis"> <!-- multiply thickness by 2.7 this increases thickness by 0.00034 -->
    <position x="-SiBarrelSiliconGap_width/4 - SiBarrelStave2_width/4" y="0" z="-SiBarrelSensor_thickness*2.7" />
        </module_component>

      </module>
      <comment> Layers composed of many arrayed modules </comment>
      <layer module="Module1" id="1" vis="TrackerLayerVis">
        <barrel_envelope
          inner_r="SiBarrelLayer2_rmin-0.5*mm"
          outer_r="SiBarrelLayer2_rmax"
          z_length="SiBarrelLayer2_length" />
        <layer_material surface="inner" binning="binPhi,binZ" bins0="128" bins1="100" />
        <layer_material surface="outer" binning="binPhi,binZ" bins0="128" bins1="100" />
        <comment>
          phi0 : Starting phi of first module.
          phi_tilt : Phi tilt of a module.
          rc : Radius of the module center.
          nphi : Number of modules in phi.
          rphi_dr : The delta radius of every other module.
          z0 : Z position of first module in phi.
          nz : Number of modules to place in z.
          dr : Radial displacement parameter, of every other module.
        </comment>
        <rphi_layout phi_tilt="0.0" nphi="SiBarrelStave2_count" phi0="0.0"
          rc="SiBarrelMod2_rmin+SiBarrel2_radius_offset" dr="SiBarrel2_radius_castellation" />
        <z_layout dr="0.0 * mm" z0="0.0 * mm" nz="1" />
      </layer>
    </detector>
  </detectors>

  <plugins>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="SagittaSiBarrel" />
      <argument value="layer_pattern: str=SagittaSiBarrel_layer\d" />
    </plugin>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="OuterSiBarrel" />
      <argument value="layer_pattern: str=OuterSiBarrel_layer\d" />
    </plugin>
  </plugins>

  <readouts>
    <readout name="SiBarrelHits">
      <segmentation type="CartesianGridXY" grid_size_x="0.020*mm" grid_size_y="0.020*mm" />
      <id>system:8,layer:4,module:12,sensor:2,x:32:-12,y:-20</id>
    </readout>
  </readouts>

</lccdd>
