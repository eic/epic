<!-- SPDX-License-Identifier: LGPL-3.0-or-later -->
<!-- Copyright (C) 2022 - 2025 Sylvester Joosten, Wouter Deconinck, Shujie Li, Aditya Yalavatti, Sam Henry -->

<lccdd>
  <define>
    <comment>
         This version is for the flat_OB geometry - a more accurate model with carbon fiber braces to
         reproduce the peaks in the material thickness scan.

         Presentation: https://indico.bnl.gov/event/29542
    </comment>

    <constant name="SiBarrelSensor_thickness" value="40*um" />
    <constant name="SiBarrelSensorMod_thickness" value="SiBarrelSensor_thickness*2.7" /> <!-- multiply thickness by 2.7 this increases thickness by 0.00034 -->
    <constant name="SiBarrelSiliconGap_width" value="1*mm" />

    <constant name="SiBarrelMod1Service_thickness" value="0.07875*mm" />
    <constant name="SiBarrelMod2Service_thickness" value="0.066045*mm" />
    <constant name="SiBarrelMod1Frame_thickness" value="0.06*mm" />
    <constant name="SiBarrelMod2Frame_thickness" value="0.12*mm" />
    <constant name="SiBarrelStave1_width" value="3.8*cm" />
    <constant name="SiBarrelStave2_width" value="3.8*cm" /> <!--UPDATED from 3.9 to 3.8-->

    <constant name="SiBarrelMod1_length"        value="50.3*cm"/>
    <comment> 84cm=2*42cm is the engineer max </comment>
    <constant name="SiBarrelMod2_length" value="84*cm - 4.7*cm" /> <!--UPDATED from 84*cm to 84*cm - 4.7*cm = 79.3cm-->

    <constant name="SiBarrelLayer1_length" value="SiBarrelMod1_length + 1*um + 0.6*cm" />
    <constant name="SiBarrelLayer2_length" value="SiBarrelMod2_length + 1*um" />
    <constant name="SiBarrelEnvelope_length" value="SiBarrelLayer2_length + 1*um" />

    <constant name="SiBarrelLayer_thickness" value="1.5*cm" />
    <constant name="SiBarrelMod1_rc" value="26.5*cm" /> <!-- 26.5 cm is the average radius for inner sub-layer of 262mm and outer of 267mm-->
    <constant name="SiBarrelMod2_rc" value="42*cm" /> <!-- 42 cm, inner/outer 417mm, 423mm -->
   <constant name="SiBarrelLayer1_rmin" value="SiBarrelMod1_rc - SiBarrelLayer_thickness / 2 " />
    <constant name="SiBarrelLayer1_rmax" value="SiBarrelLayer1_rmin + SiBarrelLayer_thickness" />
    <constant name="SiBarrelLayer2_rmin" value="SiBarrelMod2_rc -  SiBarrelLayer_thickness / 2 " />
    <constant name="SiBarrelLayer2_rmax" value="SiBarrelLayer2_rmin + SiBarrelLayer_thickness" />

    <constant name="SiBarrelStave1_count" value="46" />
    <constant name="SiBarrelStave2_count" value="70" />
    <constant name="SiBarrel1_radius_castellation" value="6*mm" />
    <constant name="SiBarrel2_radius_castellation" value="6*mm" />
    <constant name="SiBarrelMod1Lower_rc"         value="SiBarrelMod1_rc-SiBarrel1_radius_castellation/2" /> <!--get rmin of the lower modules -->
    <constant name="SiBarrelMod2Lower_rc"         value="SiBarrelMod2_rc-SiBarrel2_radius_castellation/2"/>


    <constant name="SiBarrelBrace_width" value="10*mm" />
    <constant name="SiBarrelBrace_thickness" value="2*mm" />
    <constant name="SiBarrelBrace_StaveWidthFraction" value="0.9" />
    <constant name="SiBarrelBrace_Position_X" value="-1*mm" />

    <constant name="SiBarrel1_Brace0_Position_Y" value="0.0" />
    <constant name="SiBarrel1_Brace1_Position_Y" value="13.20*cm" />
    <constant name="SiBarrel1_Brace2_Position_Y" value="24.0*cm" />
    <constant name="SiBarrel2_Brace0_Position_Y" value="0.0" />
    <constant name="SiBarrel2_Brace1_Position_Y" value="11.3*cm" />
    <constant name="SiBarrel2_Brace2_Position_Y" value="21.6*cm" />
    <constant name="SiBarrel2_Brace3_Position_Y" value="32.8*cm" />
    <constant name="SiBarrel2_Brace4_Position_Y" value="SiBarrelMod2_length/2-SiBarrelBrace_width/2" /> <!-- to align last brace edge with module edge, the center should be 79.3/2-1/2=39.15cm-->

<constant name="SiBarrelSiliconCurveNoSegments" value="5" />
<constant name="SiBarrelSiliconCurveRadius" value="100*mm" />
<constant name="SiBarrelSiliconSpace" value="1.26*mm"/>
<constant name="SiBarrelSiliconCurveHeight1" value="SiBarrelSiliconCurveRadius - sqrt(SiBarrelSiliconCurveRadius^2 - (SiBarrelStave1_width/2)^2)" />
<constant name="SiBarrelSiliconCurveHeight2" value="SiBarrelSiliconCurveRadius - sqrt(SiBarrelSiliconCurveRadius^2 - (SiBarrelStave2_width/2)^2)" />
<constant name="SiBarrelLowerCurveAxis1" value="SiBarrelSiliconCurveRadius - SiBarrelSiliconCurveHeight1 - SiBarrelMod1Frame_thickness - 0.5*SiBarrelBrace_thickness - SiBarrelSiliconSpace" />
<constant name="SiBarrelLowerCurveAxis2" value="SiBarrelSiliconCurveRadius - SiBarrelSiliconCurveHeight2 - SiBarrelMod2Frame_thickness - 0.5*SiBarrelBrace_thickness - SiBarrelSiliconSpace" />
<constant name="SiBarrelUpperCurveAxis1" value=" - SiBarrelSiliconCurveRadius + SiBarrelSiliconCurveHeight1 + SiBarrelMod1Service_thickness + 0.5*SiBarrelBrace_thickness + SiBarrelSiliconSpace" />
<constant name="SiBarrelUpperCurveAxis2" value=" - SiBarrelSiliconCurveRadius + SiBarrelSiliconCurveHeight2 + SiBarrelMod2Service_thickness + 0.5*SiBarrelBrace_thickness + SiBarrelSiliconSpace" />
<constant name="SiBarrelSiliconCurveHalfAngle1" value="asin(0.5*SiBarrelStave1_width / SiBarrelSiliconCurveRadius)" />
<constant name="SiBarrelSiliconCurveHalfAngle2" value="asin(0.5*SiBarrelStave2_width / SiBarrelSiliconCurveRadius)" />
<constant name="SiBarrelSiliconGapHalfAngle" value="atan(0.5*SiBarrelSiliconGap_width / SiBarrelSiliconCurveRadius)" />
<constant name="SiBarrel_ShortThickness" value="0.5*SiBarrelSensorMod_thickness" />
<constant name="SiBarrel1_LongThickness" value="1.5*SiBarrelSensorMod_thickness + SiBarrelMod1Service_thickness + SiBarrelMod1Frame_thickness +  SiBarrelBrace_thickness + 2*SiBarrelSiliconSpace + SiBarrelSiliconCurveHeight1"  />
<constant name="SiBarrel2_LongThickness" value="1.5*SiBarrelSensorMod_thickness + SiBarrelMod2Service_thickness + SiBarrelMod2Frame_thickness +  SiBarrelBrace_thickness + 2*SiBarrelSiliconSpace + SiBarrelSiliconCurveHeight1"  />


  </define>

  <detectors>
    <documentation level="5">
      ### Actual detectors
    </documentation>
    <detector
      id="TrackerBarrel_0_ID"
      name="SagittaSiBarrel"
      type="epic_CurvedTrackerBarrel"
      readout="SiBarrelHits"
      insideTrackingVolume="true">
      <type_flags type="DetType_TRACKER + DetType_BARREL" />
      <dimensions
        rmin="SiBarrelLayer1_rmin"
        rmax="SiBarrelLayer1_rmax"
        length="SiBarrelLayer1_length" />
      <comment>Silicon Barrel Modules</comment>
      <module name="Module1" vis="TrackerLayerVis">
      
         <module_component name="CurvedSi0C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis"> 
        <position x="0" y="-3*SiBarrelMod1_length/8" z="SiBarrelLowerCurveAxis1" />
        </module_component>
     
        <module_component name="CurvedSi2C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"          
             vis="TrackerLayerVis"> 
        <position x="0" y="SiBarrelMod1_length/8" z="SiBarrelLowerCurveAxis1" />
        </module_component>
      
        <module_component name="CurvedSi0R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel1_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconCurveHalfAngle1" 
             phi1="180*degree - SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-3*SiBarrelMod1_length/8" z="SiBarrelLowerCurveAxis1" />
        </module_component>
        
         <module_component name="CurvedSi0L"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel1_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree + SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconCurveHalfAngle1"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
          vis="TrackerLayerVis"> 
          <position x="0" y="-3*SiBarrelMod1_length/8" z="SiBarrelLowerCurveAxis1" />
        </module_component>
      
        <module_component name="CurvedSi2R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel1_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconCurveHalfAngle1" 
             phi1="180*degree - SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
          vis="TrackerLayerVis"> 
          <position x="0" y="SiBarrelMod1_length/8" z="SiBarrelLowerCurveAxis1" />
        </module_component>
     
        <module_component name="CurvedSi2L"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel1_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"    
             phi0="180*degree + SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconCurveHalfAngle1"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
          vis="TrackerLayerVis"> 
        <position x="0" y="SiBarrelMod1_length/8" z="SiBarrelLowerCurveAxis1" />
        </module_component>

      
        <module_component name="Frame"
          material="CarbonFiber"
          sensitive="false"
          width="SiBarrelStave1_width"
          length="SiBarrelMod1_length"
          thickness="SiBarrelMod1Frame_thickness"
          vis="TrackerSupportVis" >
	  <position x="0" y="0" z="-0.5*(SiBarrelBrace_thickness + SiBarrelMod1Frame_thickness)"/>
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel1_Brace0_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel1_Brace1_Position_Y" z="0" /> <!-- use z position here to shift this component relative to previous one. If zero, assume all components stacked on each other-->
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel1_Brace1_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel1_Brace2_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave1_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel1_Brace2_Position_Y" z="0" />
        </module_component>

        <module_component name="Service"
          material="Kapton"
          sensitive="false"
          width="SiBarrelStave1_width"
          length="SiBarrelMod1_length"
          thickness="SiBarrelMod1Service_thickness"
          vis="TrackerLayerVis">
          <position x="0" y="0" z="0.5*(SiBarrelBrace_thickness + SiBarrelMod1Service_thickness)" />
          </module_component>

        <module_component name="CurvedSi1R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel1_LongThickness"
             outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"       
             phi0="-SiBarrelSiliconCurveHalfAngle1" 
             phi1="-SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis"> 
          <position x="0" y="-SiBarrelMod1_length/8" z="SiBarrelUpperCurveAxis1" />
        </module_component>

        <module_component name="CurvedSi1L"
          material="Silicon"
          sensitive="true"
             innerthickness="SiBarrel1_LongThickness"
             outerthickness="SiBarrel_ShortThickness"
          nsegments="SiBarrelSiliconCurveNoSegments"
          radius="SiBarrelSiliconCurveRadius"
          phi0="SiBarrelSiliconGapHalfAngle" 
          phi1="SiBarrelSiliconCurveHalfAngle1"
          length="SiBarrelMod1_length/4"
          thickness="SiBarrelSensorMod_thickness"
          vis="TrackerLayerVis"> 
          <position x="0" y="-SiBarrelMod1_length/8" z="SiBarrelUpperCurveAxis1" />
        </module_component>

        <module_component name="CurvedSi3R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel1_LongThickness"
             outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="-SiBarrelSiliconCurveHalfAngle1" 
             phi1="-SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis"> 
          <position x="0" y="3*SiBarrelMod1_length/8" z="SiBarrelUpperCurveAxis1" />
        </module_component>
        
        <module_component name="CurvedSi3L"
          material="Silicon"
          sensitive="true"
          innerthickness="SiBarrel1_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
          nsegments="SiBarrelSiliconCurveNoSegments"
          radius="SiBarrelSiliconCurveRadius"
          phi0="SiBarrelSiliconGapHalfAngle" 
          phi1="SiBarrelSiliconCurveHalfAngle1"
          length="SiBarrelMod1_length/4"
          thickness="SiBarrelSensorMod_thickness"
          vis="TrackerLayerVis">  
          <position x="0" y="3*SiBarrelMod1_length/8" z="SiBarrelUpperCurveAxis1" />
        </module_component>
        
        <module_component name="CurvedSi1C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="-SiBarrelSiliconGapHalfAngle" 
             phi1="+SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
             <position x="0" y="-SiBarrelMod1_length/8" z="SiBarrelUpperCurveAxis1" />
        </module_component>
        
         <module_component name="CurvedSi3C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"             
             phi0="-SiBarrelSiliconGapHalfAngle" 
             phi1="+SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod1_length/4"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
        <position x="0" y="3*SiBarrelMod1_length/8" z="SiBarrelUpperCurveAxis1" />
        </module_component>

      </module>
      <comment> Layers composed of many arrayed modules </comment>
      <layer module="Module1" id="1" vis="TrackerLayerVis">
        <barrel_envelope
          inner_r="SiBarrelLayer1_rmin"
          outer_r="SiBarrelLayer1_rmax"
          z_length="SiBarrelLayer1_length" />
        <layer_material surface="inner" binning="binPhi,binZ" bins0="SiBarrelStave1_count"
          bins1="100" />
        <layer_material surface="outer" binning="binPhi,binZ" bins0="SiBarrelStave1_count"
          bins1="100" />
        <comment>
          phi0 : Starting phi of first module.
          phi_tilt : Phi tilt of a module.
          rc : Radius of the module center.
          nphi : Number of modules in phi.
          rphi_dr : The delta radius of every other module.
          z0 : Z position of first module in phi.
          nz : Number of modules to place in z.
          dr : Radial displacement parameter, of every other module.
        </comment>
        <rphi_layout phi_tilt="0.0" nphi="SiBarrelStave1_count" phi0="0.0"
          rc="SiBarrelMod1Lower_rc" dr="SiBarrel1_radius_castellation" />
        <z_layout dr="0.0 * mm" z0="0.0 * mm" nz="1" />
      </layer>
    </detector>
    <documentation level="5">
      ### Actual detectors
    </documentation>
    <detector
      id="TrackerBarrel_1_ID"
      name="OuterSiBarrel"
      type="epic_CurvedTrackerBarrel"
      readout="SiBarrelHits"
      insideTrackingVolume="true">
      <type_flags type="DetType_TRACKER + DetType_BARREL" />
      <dimensions
        rmin="SiBarrelLayer2_rmin"
        rmax="SiBarrelLayer2_rmax"
        length="SiBarrelLayer2_length" />
      <comment>Silicon Barrel Modules</comment>
      <module name="Module1" vis="TrackerLayerVis">

         <module_component name="CurvedSi0C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis"> 
        <position x="0" y="-7*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi2C"
            material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
       <position x="0" y="-3*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi4C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
       <position x="0" y="SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>
        
         <module_component name="CurvedSi6C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconGapHalfAngle" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
       <position x="0" y="5*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi0R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree - SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-7*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>
   
        <module_component name="CurvedSi0L"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree + SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-7*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi2R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree - SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-3*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi2L"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree + SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-3*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi4R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree - SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi4L"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"    
             phi0="180*degree + SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi6R"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="180*degree - SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree - SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="5*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
        </module_component>
       
        <module_component name="CurvedSi6L"
             material="Silicon"
             sensitive="true"
             innerthickness="SiBarrel_ShortThickness"
             outerthickness="SiBarrel2_LongThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"       
             phi0="180*degree + SiBarrelSiliconCurveHalfAngle2" 
             phi1="180*degree + SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="5*SiBarrelMod2_length/16" z="SiBarrelLowerCurveAxis2" />
       </module_component>



        <module_component name="Frame"
          material="CarbonFiber"
          sensitive="false"
          width="SiBarrelStave2_width"
          length="SiBarrelMod2_length"
          thickness="SiBarrelMod2Frame_thickness"
          vis="TrackerSupportVis" >
          <position x="0" y="0" z="-0.5*(SiBarrelBrace_thickness + SiBarrelMod2Frame_thickness)"/>
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace0_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace1_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace1_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace2_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace2_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace3_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace3_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="SiBarrel2_Brace4_Position_Y" z="0" />
        </module_component>

        <module_component name="Brace" material="CarbonFiber"
          width="SiBarrelStave2_width*SiBarrelBrace_StaveWidthFraction"
          thickness="SiBarrelBrace_thickness"
          length="SiBarrelBrace_width"
          vis="TrackerSupportVis">
          <position x="SiBarrelBrace_Position_X" y="-SiBarrel2_Brace4_Position_Y" z="0" />
        </module_component>

      <module_component name="Service"
          material="Kapton"
          sensitive="false"
          width="SiBarrelStave2_width"
          length="SiBarrelMod2_length"
          thickness="SiBarrelMod2Service_thickness"
          vis="TrackerLayerVis" >
          <position x="0" y="0" z="0.5*(SiBarrelBrace_thickness + SiBarrelMod1Service_thickness)" />
        </module_component>

        <module_component name="CurvedSi1R"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="-SiBarrelSiliconCurveHalfAngle2" 
             phi1="-SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-5*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>
 
        <module_component name="CurvedSi1L"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="SiBarrelSiliconCurveHalfAngle2" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-5*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi3R"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"       
             phi0="-SiBarrelSiliconCurveHalfAngle2" 
             phi1="-SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>
    
        <module_component name="CurvedSi3L"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="SiBarrelSiliconCurveHalfAngle2" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="-SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi5R"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="-SiBarrelSiliconCurveHalfAngle2" 
             phi1="-SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="3*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>
    
        <module_component name="CurvedSi5L"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="SiBarrelSiliconCurveHalfAngle2" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="3*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi7R"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"          
             phi0="-SiBarrelSiliconCurveHalfAngle2" 
             phi1="-SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="7*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>
    
        <module_component name="CurvedSi7L"
             material="Silicon"
             sensitive="true"
          innerthickness="SiBarrel2_LongThickness"
          outerthickness="SiBarrel_ShortThickness"
             nsegments="SiBarrelSiliconCurveNoSegments"
             radius="SiBarrelSiliconCurveRadius"
             phi0="SiBarrelSiliconCurveHalfAngle2" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
            vis="TrackerLayerVis"> 
          <position x="0" y="7*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>

        <module_component name="CurvedSi1C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="-SiBarrelSiliconGapHalfAngle" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
       <position x="0" y="-5*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>
        
    <module_component name="CurvedSi3C"
           material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="-SiBarrelSiliconGapHalfAngle" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
       <position x="0" y="-SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>
        
    <module_component name="CurvedSi5C"
           material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius" 
             phi0="-SiBarrelSiliconGapHalfAngle" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
       <position x="0" y="3*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
    </module_component>
               
    <module_component name="CurvedSi7C"
             material="Silicon"
             sensitive="false"
             nsegments="1"
             radius="SiBarrelSiliconCurveRadius"
             phi0="-SiBarrelSiliconGapHalfAngle" 
             phi1="SiBarrelSiliconGapHalfAngle"
             length="SiBarrelMod2_length/8"
             thickness="SiBarrelSensorMod_thickness"
             vis="TrackerLayerVis">  
       <position x="0" y="7*SiBarrelMod2_length/16" z="SiBarrelUpperCurveAxis2" />
        </module_component>

      </module>
      <comment> Layers composed of many arrayed modules </comment>
      <layer module="Module1" id="1" vis="TrackerLayerVis">
        <barrel_envelope
          inner_r="SiBarrelLayer2_rmin"
          outer_r="SiBarrelLayer2_rmax"
          z_length="SiBarrelLayer2_length" />
        <layer_material surface="inner" binning="binPhi,binZ" bins0="128" bins1="100" />
        <layer_material surface="outer" binning="binPhi,binZ" bins0="128" bins1="100" />
        <comment>
          phi0 : Starting phi of first module.
          phi_tilt : Phi tilt of a module.
          rc : Radius of the module center.
          nphi : Number of modules in phi.
          rphi_dr : The delta radius of every other module.
          z0 : Z position of first module in phi.
          nz : Number of modules to place in z.
          dr : Radial displacement parameter, of every other module.
        </comment>
        <rphi_layout phi_tilt="0.0" nphi="SiBarrelStave2_count" phi0="0.0"
          rc="SiBarrelMod2Lower_rc" dr="SiBarrel2_radius_castellation" />
        <z_layout dr="0.0 * mm" z0="0.0 * mm" nz="1" />
      </layer>
    </detector>
  </detectors>

  <plugins>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="SagittaSiBarrel" />
      <argument value="layer_pattern: str=SagittaSiBarrel_layer\d" />
    </plugin>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="OuterSiBarrel" />
      <argument value="layer_pattern: str=OuterSiBarrel_layer\d" />
    </plugin>
  </plugins>

  <readouts>
    <readout name="SiBarrelHits">
      <segmentation type="CartesianGridXY" grid_size_x="0.020*mm" grid_size_y="0.020*mm" />
      <id>system:8,layer:4,module:7,sensor:7,x:32:-12,y:-20</id>
    </readout>
  </readouts>

</lccdd>
