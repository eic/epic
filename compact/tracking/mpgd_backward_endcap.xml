<!-- SPDX-License-Identifier: LGPL-3.0-or-later -->
<!-- Copyright (C) 2023 Matt Posik, Wouter Deconinck -->

<lccdd>
<info name="mpgd_backward_endcap.xml"
      title="Micro-Pattern Gas Detector Planar Barrel Layer"
      author="mposik1983"
      url="https://github.com/mposik1983"
      status="development"
      version="1.0"
><comment/>
</info>


<define>
    <comment> Common module parameters </comment>
    <constant name="BackwardMPGDMod_allowed_space"   value="5*cm"/>   
    <constant name="BackwardMPGDMod_phi0"            value="90*deg"/>   
    <constant name="BackwardMPGDMod_phi"             value="190*deg"/>   
   <!-- <constant name="BackwardMPGD_overlap"            value="9.3*mm"/>-->
    <comment> Frame parameters </comment>
    <constant name="BackwardMPGDFrame_width"            value="2*cm"/>
    <constant name="BackwardMPGDFrame_thickness"        value="7*mm"/>


    <comment> Component thicknesses </comment>
    <constant name="BackwardMPGDWindow_thickness"             value="50*um"/>
    <constant name="BackwardMPGDWindowGap_thickness"          value="2*mm"/>
    <constant name="BackwardMPGDDriftGap_thickness"           value="3*mm"/>
    <constant name="BackwardMPGDFoilCu_thickness"             value="5*um"/>
    <constant name="BackwardMPGDReadOutElectrode_thickness"   value="10*um"/>
    <constant name="BackwardMPGDFoilKapton_thickness"         value="50*um"/>
    <constant name="BackwardMPGDReadOutNomex_thickness"       value="50*um"/>
    <constant name="BackwardMPGDReadOutKapton_thickness"      value="50*um"/>
    <constant name="BackwardMPGDPCB_thickness"                value="1.5*mm"/>
    
    <comment> Calculate total detector thickenss: active area + frame = total </comment>
    <constant name="BackwardMPGD_material_thickness" value="BackwardMPGDWindow_thickness 
                                                          + BackwardMPGDFoilKapton_thickness + BackwardMPGDFoilCu_thickness
                                                          + BackwardMPGDFoilKapton_thickness + BackwardMPGDFoilCu_thickness
                                                          + BackwardMPGDReadOutNomex_thickness + BackwardMPGDReadOutElectrode_thickness + BackwardMPGDReadOutKapton_thickness
                                                          + BackwardMPGDPCB_thickness"/>
    <constant name="BackwardMPGD_gas_thickness"      value="BackwardMPGDDriftGap_thickness + BackwardMPGDWindowGap_thickness"/>
    <constant name="BackwardMPGD_thickness"          value="BackwardMPGD_material_thickness + BackwardMPGDFrame_thickness"/>
    <constant name="BackwardMPGD_overlap"            value="2*BackwardMPGD_thickness"/>

    <constant name="BackwardMPGD_hole_offset"                      value="0.0*mm"/>  
 </define>

   <detectors>
     <detector 
       id="TrackerEndcapN_4_ID" 
       name="BackwardMPGD" 
       type="epic_DiskMPGDTrackerN" 
       readout="BackwardMPGDEndcapHits"
       reflect="false"
       vis="MPGDVis">
     <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
     <dimensions 
       rmin="BackwardMPGDMod1_rmin" 
       rmax="BackwardMPGDMod1_rmax" 
       thickness="BackwardMPGDMod_allowed_space" 
       phi0="BackwardMPGDMod_phi0" 
       phi="BackwardMPGDMod_phi"/>
     <position x="0" y="0" z="0" />
     <comment> Module components</comment>
     <module name="BackwardMPGDEndcapModule1" vis="MPGDModuleVis">
	<comment> Window and drift region </comment>
        <module_component name="DriftGap"
               vis="MPGDVis"
               material="Ar"
               sensitive="true"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDDriftGap_thickness"/>
        <module_component name="WindowGasGap"
               vis="MPGDVis"
               material="Ar"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDWindowGap_thickness"/>
        <module_component name="Window"
               vis="MPGDVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDWindow_thickness"/>
        <comment> HV Cathode </comment>
        <module_component name="Kapton Cathode"
               vis="MPGDVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilKapton_thickness"/>
        <module_component name="Cu Cathode"
               vis="MPGDVis"
               material="Copper"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilCu_thickness"/>
	<comment> Amplification foil (based on uRWELL) </comment>
        <module_component name="Amp. Cu"
               vis="MPGDVis"
               material="Copper"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilCu_thickness"/>
        <module_component name="Amp Kapton"
               vis="MPGDVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilKapton_thickness"/>
        <comment> Readout/Backboard </comment>
        <module_component name="Readout Nomex"
               vis="TrackerMPGDGasVis"
               material="Nomex"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDReadOutNomex_thickness"/>
        <module_component name="Readout Electrodes"
               vis="TrackerMPGDGasVis"
               material="Copper"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDReadOutElectrode_thickness"/>
        <module_component name="Readout Kapton"
               vis="TrackerMPGDGasVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDReadOutKapton_thickness"/>
        <module_component name="Readout PCB"
               vis="TrackerMPGDGasVis"
               material="Fr4"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDPCB_thickness"/>
       <!--
	       <frame vis="TrackerSupportVis"
	       material="Fr4"
	       width="BackwardMPGDFrame_width"
	       thickness="BackwardMPGDFrame_thickness"
	       phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"/>
       -->
   </module>

  <layer module="BackwardMPGDEndcapModule1" id="0" vis="TrackerSupportVis">
    <envelope_tolerance r_min="-50*mm" r_max="0*mm" z_min="0*mm" z_max="0*mm"/>
    <layer_material surface="inner" binning="binPhi,binZ" bins0="100" bins1="100" />
    <rphi_layout
          phi_tilt="0"
          nphi="2"
          phi0="BackwardMPGDMod_phi0"
	  rc="0*cm"
	   dr="0"/>
    <z_layout
	  dr="0"
	  z0="-BackwardMPGD_zmin"
	  dz="BackwardMPGD_overlap"/>
           
    </layer>
    <comment> 2nd module </comment>
    <module name="BackwardMPGDEndcapModule2" vis="TrackerVis">
	<comment> Window and drift region </comment>
        <module_component name="DriftGap"
               vis="MPGDVis"
               material="Ar"
               sensitive="true"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDDriftGap_thickness"/>
        <module_component name="WindowGasGap"
               vis="MPGDVis"
               material="Ar"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDWindowGap_thickness"/>
        <module_component name="Window"
               vis="MPGDVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDWindow_thickness"/>
	<comment>HV Cathode </comment>
        <module_component name="Kapton Cathode"
               vis="MPGDVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod1_rmin"
	       rmax="BackwardMPGDMod1_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilKapton_thickness"/>
        <module_component name="Cu Cathode"
               vis="MPGDVis"
               material="Copper"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilCu_thickness"/>
	<comment> Amplification foil (based on uRWELL) </comment>
        <module_component name="Amp. Cu"
               vis="MPGDVis"
               material="Copper"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilCu_thickness"/>
        <module_component name="Amp Kapton"
               vis="MPGDVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDFoilKapton_thickness"/>
        <comment> Readout/Backboard </comment>
        <module_component name="Readout Nomex"
               vis="TrackerMPGDGasVis"
               material="Nomex"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDReadOutNomex_thickness"/>
        <module_component name="Readout Electrodes"
               vis="TrackerMPGDGasVis"
               material="Copper"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDReadOutElectrode_thickness"/>
        <module_component name="Readout Kapton"
               vis="TrackerMPGDGasVis"
               material="Kapton"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDReadOutKapton_thickness"/>
        <module_component name="Readout PCB"
               vis="TrackerMPGDGasVis"
               material="Fr4"
               sensitive="false"
               rmin="BackwardMPGDMod2_rmin"
	       rmax="BackwardMPGDMod2_rmax"
               phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"
	       thickness="BackwardMPGDPCB_thickness"/>
	<!-- 
	      <frame vis="TrackerSupportVis"
	       material="Fr4"
	       width="BackwardMPGDFrame_width"
	       thickness="BackwardMPGDFrame_thickness"
	       phi0="BackwardMPGDMod_phi0"
	       phi ="BackwardMPGDMod_phi"/>
	-->
	       	
   </module>
  <layer module="BackwardMPGDEndcapModule2" id="1" vis="TrackerSupportVis">
    <envelope_tolerance r_min="-50*mm" r_max="0*mm" z_min="0*mm" z_max="0*mm"/>
    <layer_material surface="inner" binning="binPhi,binZ" bins0="100" bins1="100" />
    <rphi_layout
          phi_tilt="0"
          nphi="2"
          phi0="BackwardMPGDMod_phi0"
	  rc="0*cm"
	  dr="0"/>
    <z_layout
	  dr="0"
	  z0="-(BackwardMPGD_zmin + BackwardMPGDMod_offset)"
	  dz="BackwardMPGD_overlap"/>
    </layer>
  </detector>
</detectors>

  <readouts>
    <readout name="BackwardMPGDEndcapHits">
      <segmentation type="CartesianGridXY" grid_size_x="0.150*mm*sqrt(12)" grid_size_y="0.150*mm*sqrt(12)" />
      <id>system:8,layer:4,module:12,sensor:2,x:32:-14,y:-18</id>
    </readout>
  </readouts>

  <plugins>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="BackwardMPGD"/>
      <argument value="layer_pattern: str=BackwardMPGDEndcap_layer\d"/>
    </plugin>
  </plugins>

  <fields>
  </fields>
</lccdd>
