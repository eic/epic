<!-- SPDX-License-Identifier: LGPL-3.0-or-later -->
<!-- Copyright (C) 2022 Sylvester Joosten, Wouter Deconinck, Shujie Li -->

<lccdd>
  <comment>
    Main parameters. June 2022 setup with symmetric disk locations.
    Here to comply with the ACTS translation onion structure we have:
      - the first disk in the inner tracking assembly,
      - the second silicon disk in the middle silicon tracking assembly
      - the and the following 3 disks in the outer silicon tracking assembly
    in their own tracking assembly.
  </comment>

  <define>

    <comment> Main tracker disk setup </comment>

    <comment> Support/service thicknesses from ATHENA disks for now </comment>
    <constant name="SiTrackerEndcapAl_thickness"    value="0.15*mm"/>
    <constant name="SiTrackerEndcapCF_thickness"    value="0.12*mm"/>
    <constant name="SiTrackerSensor_thickness"      value="40*um"/>

    <comment> Currently parametrized as 36 pie-shaped modules to approximate disk </comment>
    <constant name="SiTrackerEndcapMod_count"       value="2"/>
    <constant name="SiTrackerEndcapMod_dz"          value="0" />
    <constant name="SiTrackerEndcapMod_overlap"     value="0"/>

    <comment> Global Si endcap variables </comment>
    <constant name="SiTrackerEndcapMod_thickness"   value="SiTrackerEndcapCF_thickness + SiTrackerEndcapAl_thickness + SiTrackerSensor_thickness" />
    <constant name="SiTrackerEndcapMod_angle"       value="360.0*degree / SiTrackerEndcapMod_count * (1 + SiTrackerEndcapMod_overlap)" />
    <constant name="SiTrackerEndcapLayer_thickness" value="SiTrackerEndcapMod_thickness + 2 * SiTrackerEndcapMod_dz + 1*um" />

  </define>

  <comment>
    Inner silicon tracker disks
  </comment>
  <define>
    <constant name="InnerTrackerEndcapPMod1_zmin"   value="InnerTrackerEndcapP_zmin" />
    <constant name="InnerTrackerEndcapPMod1_rmin"   value="InnerTrackerEndcapP_rmin" />
    <constant name="InnerTrackerEndcapPMod1_rmax"   value="InnerTrackerEndcapP_rmax" />
    <constant name="InnerTrackerEndcapPMod1_x1"     value="2 * InnerTrackerEndcapPMod1_rmin * tan(SiTrackerEndcapMod_angle/2)" />
    <constant name="InnerTrackerEndcapPMod1_x2"     value="2 * InnerTrackerEndcapPMod1_rmax * sin(SiTrackerEndcapMod_angle/2)" />
    <constant name="InnerTrackerEndcapPMod1_y"      value="InnerTrackerEndcapPMod1_rmax * cos(SiTrackerEndcapMod_angle/2) - InnerTrackerEndcapPMod1_rmin" />
    <constant name="InnerTrackerEndcapPLayer1_rmin" value="InnerTrackerEndcapPMod1_rmin - 1*um" />
    <constant name="InnerTrackerEndcapPLayer1_rmax" value="InnerTrackerEndcapPMod1_rmax + 1*um" />
    <constant name="InnerTrackerEndcapPLayer1_zmin" value="InnerTrackerEndcapPMod1_zmin - SiTrackerEndcapLayer_thickness/2" />


    <!-- <constant name="InnerTrackerEndcapNMod1_zmin"   value="InnerTrackerEndcapN_zmin" /> -->
    <constant name="InnerTrackerEndcapNMod1_zmin"   value="105*cm" />
    <constant name="InnerTrackerEndcapNMod1_rmin"   value="InnerTrackerEndcapN_rmin+0*mm+0*cm" />
    <constant name="InnerTrackerEndcapNMod1_rmax"   value="InnerTrackerEndcapN_rmax" />
    <constant name="InnerTrackerEndcapNMod1_x1"     value="2 * InnerTrackerEndcapNMod1_rmin * tan(SiTrackerEndcapMod_angle/2)" />
    <constant name="InnerTrackerEndcapNMod1_x2"     value="2 * InnerTrackerEndcapNMod1_rmax * sin(SiTrackerEndcapMod_angle/2)" />
    <constant name="InnerTrackerEndcapNMod1_y"      value="InnerTrackerEndcapNMod1_rmax * cos(SiTrackerEndcapMod_angle/2) - InnerTrackerEndcapNMod1_rmin" />
    <constant name="InnerTrackerEndcapNLayer1_rmin" value="InnerTrackerEndcapNMod1_rmin- 1*um" />
    <constant name="InnerTrackerEndcapNLayer1_rmax" value="InnerTrackerEndcapNMod1_rmax + 1*um" />
    <constant name="InnerTrackerEndcapNLayer1_zmin" value="InnerTrackerEndcapNMod1_zmin - SiTrackerEndcapLayer_thickness/2" />

    <constant name="m_x0"   value="1*cm" />
    <constant name="m_y0"   value="InnerTrackerEndcapNMod1_rmin+1*mm" />
    <constant name="m_x"   value="15*cm" />
    <constant name="m_y"   value="12*cm" />

  </define>
  <detectors>
    <!-- <detector
      id="TrackerEndcapP_0_ID"
      name="InnerTrackerEndcapP"
      type="epic_TrapEndcapTracker"
      readout="TrackerEndcapHits"
      vis="TrackerVis"
      reflect="false">
      <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
      <module name="Module1" vis="TrackerModuleVis">
        <trd x1="InnerTrackerEndcapPMod1_x1/2" x2="InnerTrackerEndcapPMod1_x2/2" z="InnerTrackerEndcapPMod1_y/2" />
        <module_component thickness="SiTrackerEndcapCF_thickness" material="CarbonFiber" vis="TrackerSupportVis" />
        <module_component thickness="SiTrackerEndcapAl_thickness" material="Aluminum" vis="TrackerServiceVis" />
        <module_component thickness="SiTrackerSensor_thickness" material="Silicon" sensitive="true" vis="TrackerLayerVis" />
      </module>
      <layer id="1">
        <envelope vis="TrackerLayerVis"
          rmin="InnerTrackerEndcapPLayer1_rmin"
          rmax="InnerTrackerEndcapPLayer1_rmax"
          length="SiTrackerEndcapLayer_thickness"
          zstart="InnerTrackerEndcapPLayer1_zmin" />
        <layer_material surface="inner" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <layer_material surface="outer" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <ring
          r="InnerTrackerEndcapPMod1_rmin + InnerTrackerEndcapPMod1_y/2"
          zstart="0"
          nmodules="SiTrackerEndcapMod_count"
          dz="SiTrackerEndcapMod_dz"
          module="Module1" />
      </layer>
    </detector> -->
    <detector
      id="TrackerEndcapP_0_ID"
      name="InnerTrackerEndcapP"
      type="epic_Tile2EndcapTracker"
      readout="TrackerEndcapHits"
      vis="TrackerVis"
      reflect="false">
      <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
      <module name="Module1" vis="TrackerModuleVis">
        <trd y="m_y"  x="m_x" dz="SiTrackerEndcapLayer_thickness-1*um"/>
        <module_component thickness="SiTrackerEndcapCF_thickness" material="CarbonFiber" vis="TrackerSupportVis" />
        <module_component thickness="SiTrackerEndcapAl_thickness" material="Aluminum" vis="TrackerServiceVis" />
        <module_component thickness="SiTrackerSensor_thickness" material="Silicon" sensitive="true" vis="TrackerLayerVis" />
      </module>
      <layer id="1">
        <envelope vis="TrackerLayerVis"
          rmin="InnerTrackerEndcapPLayer1_rmin"
          rmax="InnerTrackerEndcapPLayer1_rmax"
          length="SiTrackerEndcapLayer_thickness"
          zstart="InnerTrackerEndcapPLayer1_zmin" />
        <layer_material surface="inner" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <layer_material surface="outer" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <ring
          zstart="0"
          x="m_x0*cm"
          y="m_y0+m_y/2.0"
          nmodules="SiTrackerEndcapMod_count"
          dz="SiTrackerEndcapMod_dz"
          module="Module1" />
      </layer>
    </detector>
    <detector
      id="TrackerEndcapN_0_ID"
      name="InnerTrackerEndcapN"
      type="epic_Tile2EndcapTracker"
      readout="TrackerEndcapHits"
      vis="TrackerVis"
      reflect="true">
      <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
      <module name="Module1" vis="TrackerModuleVis">
        <trd y="m_y"  x="m_x" dz="SiTrackerEndcapLayer_thickness-1*um"/>
        <module_component thickness="SiTrackerEndcapCF_thickness" material="CarbonFiber" vis="TrackerSupportVis" />
        <module_component thickness="SiTrackerEndcapAl_thickness" material="Aluminum" vis="TrackerServiceVis" />
        <module_component thickness="SiTrackerSensor_thickness" material="Silicon" sensitive="true" vis="TrackerLayerVis" />
      </module>
      <layer id="1">
        <envelope vis="TrackerLayerVis"
          rmin="InnerTrackerEndcapNLayer1_rmin"
          rmax="InnerTrackerEndcapNLayer1_rmax"
          length="SiTrackerEndcapLayer_thickness"
          zstart="InnerTrackerEndcapNLayer1_zmin" />
        <layer_material surface="inner" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <layer_material surface="outer" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <ring
          zstart="0"
          x="m_x0"
          y="m_y0+m_y/2.0"
          nmodules="SiTrackerEndcapMod_count"
          dz="SiTrackerEndcapMod_dz"
          module="Module1" />
      </layer>
    </detector>
<!-- 
    <detector
      id="TrackerEndcapN_0_ID"
      name="InnerTrackerEndcapN"
      type="epic_TrapEndcapTracker"
      readout="TrackerEndcapHits"
      vis="TrackerVis"
      reflect="true">
      <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
      <module name="Module1" vis="TrackerModuleVis">
        <trd x1="InnerTrackerEndcapNMod1_x1/2" x2="InnerTrackerEndcapNMod1_x2/2" z="InnerTrackerEndcapNMod1_y/2" />
        <module_component thickness="SiTrackerEndcapCF_thickness" material="CarbonFiber" vis="TrackerSupportVis" />
        <module_component thickness="SiTrackerEndcapAl_thickness" material="Aluminum" vis="TrackerServiceVis" />
        <module_component thickness="SiTrackerSensor_thickness" material="Silicon" sensitive="true" vis="TrackerLayerVis" />
      </module>
      <layer id="1">
        <envelope vis="TrackerLayerVis"
          rmin="InnerTrackerEndcapNLayer1_rmin"
          rmax="InnerTrackerEndcapNLayer1_rmax"
          length="SiTrackerEndcapLayer_thickness"
          zstart="InnerTrackerEndcapNLayer1_zmin" />
        <layer_material surface="inner" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <layer_material surface="outer" binning="binPhi,binR" bins0="5*SiTrackerEndcapMod_count" bins1="100"/>
        <ring
          r="InnerTrackerEndcapNMod1_rmin + InnerTrackerEndcapNMod1_y/2"
          zstart="0"
          nmodules="SiTrackerEndcapMod_count"
          dz="SiTrackerEndcapMod_dz"
          module="Module1" />
      </layer>
    </detector> -->
  </detectors>

  <plugins>

    <plugin name="DD4hep_ParametersPlugin">
      <argument value="InnerTrackerEndcapP"/>
      <argument value="layer_pattern: str=InnerTrackerEndcapP_layer\d_P"/>
    </plugin>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="InnerTrackerEndcapN"/>
      <argument value="layer_pattern: str=InnerTrackerEndcapN_layer\d_N"/>
    </plugin>
   
  </plugins>

  <readouts>
      <!-- <readout name="TrackerEndcapHits">
      <segmentation type="CartesianGridXZ" grid_size_x="0.020*mm" grid_size_z="0.020*mm" />
      <id>system:8,layer:4,module:12,sensor:2,x:32:-16,z:-16</id>
    </readout> -->
    <readout name="TrackerEndcapHits">
      <segmentation type="CartesianGridXY" grid_size_x="0.020*mm" grid_size_y="0.020*mm" />
      <id>system:8,layer:4,module:12,sensor:2,x:32:-16,y:-16</id>
    </readout>
  </readouts>

</lccdd>
