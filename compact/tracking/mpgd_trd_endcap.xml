<!-- SPDX-License-Identifier: LGPL-3.0-or-later -->
<!-- Copyright (C) 2022 Whitney Armstrong, Sylvester Joosten, Matt Posik, Jihee Kim -->

<lccdd>
<info name="mpgd_trd_endcap.xml"
      title="Micro-Pattern Gas Detector based Transition Radiation Detector for e/Pi discrimination and tracking"
      author="mposik1983"
      url="https://github.com/mposik1983"
      status="development"
      version="1.0"
><comment/>
</info>

  <comment> Forward MPGD-TRD development for ePIC upgrade or EIC detector 2  </comment>
  <comment>
      ____X2____
      \        /
       \      /    Y (=z for the trd)
        \_X1_/
  </comment>

  <define>

    <comment> Main Detector Parameters </comment>
    <constant name="MPGDTRDEndcapPMod_count"       value="12"/>
    <constant name="MPGDTRDEndcapPMod_dz"          value="0" />
    <constant name="MPGDTRDEndcapPMod_overlap"     value="0"/>
    <constant name="MPGDTRDEndcapPMod_zmin"        value="10*cm" />
    <constant name="MPGDTRDEndcapP_rmin"           value="8.5*cm" />
    <constant name="MPGDTRDEndcapP_rmax"           value="185*cm" />
    <constant name="MPGDTRDEndcapP_RadiatorGap"    value="0"/>
    <comment>
	    zmin, rmin, rmax can be defined in compact/tracking/definition.xml relative to DIRC detector via
            <constant name="MPGDTRDEndcapPMod_zmin"         value="DRICH_zmax" />
            <constant name="MPGDTRDEndcapP_rmin"            value="DRICH_rmin0" />
	    <constant name="MPGDTRDEndcapP_rmax"            value="DRICH_rmin1" />
	    but will keep hard coded values for now
    </comment>
    <comment> frame parameters -- to be implimented later </comment>
    <constant name="MPGDTRDFrame_width"             value="20*mm"/>
    <constant name="MPGDTRDFrame_thickness"         value="7*mm" />

    <comment> MPGD-TRD Module Parameters </comment>
    <constant name="MPGDTRDWindow_thickness"           value="0"    />
    <constant name="MPGDTRDWindowGap_thickness"        value="0"    />
    <constant name="MPGDTRDDriftgap_thickness"         value="3*cm" />
    <constant name="MPGDTRDFoilCu_thickness"           value="5*um" />
    <constant name="MPGDTRDFoilKapton_thickness"       value="50*um"/>
    <constant name="MPGDTRDReadOutKapton_thickness"    value="50*um"/>
    <constant name="MPGDTRDReadOutElectrode_thickness" value="10*um"/>
    <constant name="MPGDTRDReadOutNomex_thickness"     value="50*um"/>
    <constant name="MPGDTRDPCB_thickness"              value="3*mm" />

    <constant name="MPGDTRDCathode_thickness"          value="MPGDTRDFoilKapton_thickness + MPGDTRDFoilCu_thickness"/>
    <constant name="MPGDTRDFoil_thickness"             value="MPGDTRDFoilKapton_thickness + MPGDTRDFoilCu_thickness"/>
    <constant name="MPGDTRDReadOut_thickness"          value="MPGDTRDReadOutNomex_thickness + MPGDTRDReadOutElectrode_thickness + MPGDTRDReadOutKapton_thickness"/>
    <constant name="MPGDTRDModule_thickness"           value="MPGDTRDWindow_thickness + MPGDTRDCathode_thickness + MPGDTRDFoil_thickness + MPGDTRDDriftgap_thickness + 
	                                                      MPGDTRDReadOut_thickness + MPGDTRDPCB_thickness + MPGDTRDFrame_thickness"/>
    <comment> Radiator Module Parameters </comment>
    <constant name="Radiator_thickness"            value="15*cm"/>
    <constant name="RadiatorModule_thickness"      value="Radiator_thickness"/>

    <comment> Layer parameters </comment>
    <constant name="MPGDTRDEndcapPMod_thickness"   value="RadiatorModule_thickness + MPGDTRDEndcapP_RadiatorGap + MPGDTRDModule_thickness" />
    <constant name="MPGDTRDEndcapPMod_angle"       value="360.0*degree / MPGDTRDEndcapPMod_count * (1 + MPGDTRDEndcapPMod_overlap)" />
    <constant name="MPGDTRDEndcapPMod1_zmin"   value="MPGDTRDEndcapPMod_zmin" />
    <constant name="TrackerEndcapPMod1_rmax"   value="MPGDTRDEndcapP_rmax" />
    <constant name="TrackerEndcapPMod1_x1"     value="2 * MPGDTRDEndcapP_rmin * tan(MPGDTRDEndcapPMod_angle/2)" />
    <constant name="TrackerEndcapPMod1_x2"     value="2 * TrackerEndcapPMod1_rmax * sin(MPGDTRDEndcapPMod_angle/2)" />
    <constant name="TrackerEndcapPMod1_y"      value="TrackerEndcapPMod1_rmax * cos(MPGDTRDEndcapPMod_angle/2) - MPGDTRDEndcapP_rmin" />
    <constant name="TrackerEndcapPLayer1_rmin" value="MPGDTRDEndcapP_rmin - 1*um" />
    <constant name="TrackerEndcapPLayer1_rmax" value="TrackerEndcapPMod1_rmax + 1*um" />
    <constant name="TrackerEndcapPLayer1_zmin" value="MPGDTRDEndcapPMod1_zmin" />
    <constant name="TrackerEndcapPMod2_zmin"   value="MPGDTRDEndcapPMod1_zmin + RadiatorModule_thickness + MPGDTRDEndcapP_RadiatorGap + 0*MPGDTRDModule_thickness/2" />
    <constant name="TrackerEndcapPMod2_rmin"   value="MPGDTRDEndcapP_rmin" />
    <constant name="TrackerEndcapPMod2_rmax"   value="MPGDTRDEndcapP_rmax" />
    <constant name="TrackerEndcapPMod2_x1"     value="2 * TrackerEndcapPMod2_rmin * tan(MPGDTRDEndcapPMod_angle/2)" />
    <constant name="TrackerEndcapPMod2_x2"     value="2 * TrackerEndcapPMod2_rmax * sin(MPGDTRDEndcapPMod_angle/2)" />
    <constant name="TrackerEndcapPMod2_y"      value="TrackerEndcapPMod2_rmax * cos(MPGDTRDEndcapPMod_angle/2) - TrackerEndcapPMod2_rmin" />
    <constant name="TrackerEndcapPLayer2_rmin" value="MPGDTRDEndcapP_rmin" />
    <constant name="TrackerEndcapPLayer2_rmax" value="MPGDTRDEndcapP_rmax" />
    <constant name="TrackerEndcapPLayer2_zmin" value="TrackerEndcapPMod2_zmin" />

  </define>
  <detectors>
    <detector
      id="TrackerEndcapP_3_ID"
      name="MPGDTRDEndcapP"
      type="epic_TrapEndcapTracker"
      readout="MPGDTRDEndcapHits"
      vis="TrackerVis"
      reflect="false">
      <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
      <comment> TRD radiator </comment>
      <module name="Module1" vis="TrackerSupportVis">
        <trd x1="TrackerEndcapPMod1_x1/2" x2="TrackerEndcapPMod1_x2/2" z="TrackerEndcapPMod1_y/2" />
        <module_component thickness="Radiator_thickness" material="radiatorMatCustom" vis="TrackerSupportVis" />
      </module>
      <comment> MPGD-TRD active layer </comment>
      <module name="Module2" vis="TrackerModuleVis">
        <trd x1="TrackerEndcapPMod2_x1/2" x2="TrackerEndcapPMod2_x2/2" z="TrackerEndcapPMod2_y/2" />
	<module_component name="Cathode_Kapton"    thickness="MPGDTRDFoilKapton_thickness" material="Kapton" sensitive="false" vis="TrackerLayerVis" />
	<module_component name="Cathode_Cu"        thickness="MPGDTRDFoilCu_thickness" material="Copper" sensitive="false" vis="TrackerLayerVis" />
        <module_component name="DriftGap"          thickness="MPGDTRDDriftgap_thickness" material="Xe20CO2" sensitive="true" vis="TrackerLayerVis" />
	<module_component name="MPGD_Cu"           thickness="MPGDTRDFoilCu_thickness" material="Copper" sensitive="false" vis="TrackerLayerVis" />
	<module_component name="MPGD_Kapton"       thickness="MPGDTRDFoilKapton_thickness" material="Kapton" sensitive="false" vis="TrackerLayerVis" />
	<module_component name="ReadOutElectrodes" thickness="MPGDTRDReadOutElectrode_thickness" material="Copper" sensitive="false" vis="TrackerLayerVis" />
	<module_component name="ReadOutKapton"     thickness="MPGDTRDReadOutKapton_thickness" material="Kapton" sensitive="false" vis="TrackerLayerVis" /> 
	<module_component name="PCB"               thickness="MPGDTRDPCB_thickness" material="Fr4" sensitive="false" vis="TrackerLayerVis" />
      </module>
      <layer id="1">
        <envelope vis="TrackerSupportVis"
          rmin="TrackerEndcapPLayer1_rmin"
          rmax="TrackerEndcapPLayer1_rmax"
          length="RadiatorModule_thickness"
          zstart="TrackerEndcapPLayer1_zmin" />
	      <!--<layer_material surface="inner" binning="binPhi,binR" bins0="12" bins1="20"/>-->
        <ring
          r="MPGDTRDEndcapP_rmin + TrackerEndcapPMod1_y/2"
          zstart="0"
          nmodules="MPGDTRDEndcapPMod_count"
          dz="MPGDTRDEndcapPMod_dz"
          module="Module1" />
      </layer>
      <layer id="2">
        <envelope vis="TrackerLayerVis"
          rmin="TrackerEndcapPLayer2_rmin"
          rmax="TrackerEndcapPLayer2_rmax"
          length="MPGDTRDModule_thickness"
          zstart="TrackerEndcapPLayer2_zmin" />
        <layer_material surface="inner" binning="binPhi,binR" bins0="12" bins1="20"/>
        <ring
          r="TrackerEndcapPMod2_rmin + TrackerEndcapPMod2_y/2"
          zstart="0"
          nmodules="MPGDTRDEndcapPMod_count"
          dz="MPGDTRDEndcapPMod_dz"
          module="Module2" />
      </layer>
    </detector>
  </detectors>

  <plugins>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="MPGDTRDEndcapP"/>
      <argument value="layer_pattern: str=MPGDTRDEndcapP_layer\d_P"/>
    </plugin>
  </plugins>

  <readouts>
    <readout name="MPGDTRDEndcapHits">
      <segmentation type="CartesianGridXZ" grid_size_x="0.150*mm*sqrt(12)" grid_size_z="0.150*mm*sqrt(12)" />
      <id>system:8,layer:4,module:12,sensor:2,x:32:-16,z:-16</id>
    </readout>
  </readouts>

</lccdd>
