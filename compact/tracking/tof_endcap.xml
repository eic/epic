<!-- SPDX-License-Identifier: LGPL-3.0-or-later -->
<!-- Copyright (C) 2022 Nicolas Schmidt -->

<lccdd>
  <define>
    <comment>
      --------------------------
      Forward TOF Parameters
      --------------------------
    </comment>
    <comment> Forward TOF position </comment>
	    <!--<constant name="ForwardTOF_length"              value="min(ForwardTOFRegion_length, 2.*cm)"/>
	    <constant name="ForwardTOF_zmin"                value="ForwardTOFRegion_zmin + ForwardTOFRegion_length - ForwardTOF_length - 1*cm"/>-->
    <constant name="ForwardTOF_nlayers"             value="1"/>
    <constant name="ForwardTOFMod_offset"           value="1.2*cm"/>

    <comment> LGAD parameters for the endcap TOFs </comment>
    <constant name="TOFEndcapSensor_thickness"      value="300*um" />
    <constant name="TOFEndcapService_thickness"     value="5.00/100*9.37*cm-TOFEndcapSensor_thickness" />
    <constant name="TOFEndcapMod_count"             value="36" />
    <constant name="TOFEndcapMod_dz"                value="0" />
    <constant name="TOFEndcapMod_overlap"           value="0" />

    <constant name="TOFEndcap_cooling_plate_height" value="1*mm" />
    <constant name="TOFEndcap_diameter_coolingtube" value="5*mm" />
    <constant name="TOFEndcap_wallthickness_coolingtube" value="1*mm" />
    <constant name="TOFEndcap_sensor_width"         value="21.2*mm" />
    <constant name="TOFEndcap_sensor_length"        value="42.0*mm" />
    <constant name="TOFEndcap_baseplate_length"     value="43.1*mm" />
    <constant name="TOFEndcap_baseplate_width"      value="56.5*mm/2" />


    <comment> Layer definitions around the sensor for the endcap TOFs </comment>
    <constant name="SS_TP_thickness"        value="0.25*mm" />
    <constant name="SS_TP_width"            value="TOFEndcap_baseplate_width-0.3*mm" />
    <constant name="SS_TP_offset"           value="0.3*mm/2" />
    <constant name="SS_TP_length"           value="TOFEndcap_baseplate_length-0.2*mm" />

    <constant name="SS_ALNBtm_thickness"            value="0.79*mm" />
    <constant name="SS_ALNBtm_width"                value="TOFEndcap_baseplate_width" />
    <constant name="SS_ALNBtm_offset"               value="0*mm" />
    <constant name="SS_ALNBtm_length"               value="TOFEndcap_baseplate_length" />

    <constant name="SS_LairdFilm_thickness"         value="0.08*mm" />
    <constant name="SS_LairdFilm_width"             value="TOFEndcap_sensor_width+1*mm" />
    <constant name="SS_LairdFilm_offset"            value="(TOFEndcap_baseplate_width-SS_LairdFilm_width)/2-0.2*mm" />
    <constant name="SS_LairdFilm_length"            value="TOFEndcap_sensor_length+0.2*mm" />

    <constant name="SS_ROC_thickness"               value="0.25*mm" />
    <constant name="SS_ROC_width"                   value="TOFEndcap_sensor_width+1*mm" />
    <constant name="SS_ROC_offset"                  value="(TOFEndcap_baseplate_width-SS_ROC_width)/2-0.2*mm" />
    <constant name="SS_ROC_length"                  value="TOFEndcap_sensor_length+0.2*mm" />

    <constant name="SS_Solder_thickness"            value="0.03*mm" />
    <constant name="SS_Solder_width"                value="TOFEndcap_sensor_width-0.2*mm" />
    <constant name="SS_Solder_offset"               value="(TOFEndcap_baseplate_width-SS_Solder_width)/2-0.1*mm" />
    <constant name="SS_Solder_length"               value="TOFEndcap_sensor_length-0.2*mm" />

    <constant name="SS_Sensor_thickness"            value="0.3*mm" />
    <constant name="SS_Sensor_width"                value="TOFEndcap_sensor_width" />
    <constant name="SS_Sensor_offset"               value="(TOFEndcap_baseplate_width-SS_Sensor_width-0.1*mm)/2" />
    <constant name="SS_Sensor_length"               value="TOFEndcap_sensor_length" />

    <constant name="SS_Epoxy_thickness"             value="0.08*mm" />
    <constant name="SS_Epoxy_width"                 value="TOFEndcap_sensor_width" />
    <constant name="SS_Epoxy_offset"                value="(TOFEndcap_baseplate_width-SS_Epoxy_width-0.1*mm)/2" />
    <constant name="SS_Epoxy_length"                value="TOFEndcap_sensor_length" />

    <constant name="SS_ALNTop_thickness"            value="0.51*mm" />
    <constant name="SS_ALNTop_width"                value="TOFEndcap_baseplate_width-4*mm" />
    <constant name="SS_ALNTop_offset"               value="4.0*mm/2-0.2*mm" />
    <constant name="SS_ALNTop_length"               value="TOFEndcap_baseplate_length-0.2*mm" />


    <comment> Service hybrid layer information. </comment>
    <constant name="SH_TP_thickness"        value="0.25*mm" />
    <constant name="SH_TP_width"            value="TOFEndcap_baseplate_width/2-0.2*mm" />
    <constant name="SH_TP_offset"           value="0.2*mm/2" />
    <constant name="SH_TP_length"           value="TOFEndcap_baseplate_length" />

    <constant name="SH_HSB_thickness"       value="1.0*mm" />
    <constant name="SH_HSB_width"           value="TOFEndcap_baseplate_width/2-0.2*mm" />
    <constant name="SH_HSB_offset"          value="0.2*mm/2" />
    <constant name="SH_HSB_length"          value="TOFEndcap_baseplate_length" />

    <constant name="SH_ConnSp_thickness"    value="1.50*mm" />
    <constant name="SH_ConnSp_width"        value="TOFEndcap_baseplate_width/2-0.35*mm" />
    <constant name="SH_ConnSp_offset"       value="0.35*mm/2" />
    <constant name="SH_ConnSp_length"       value="TOFEndcap_baseplate_length" />

    <constant name="SH_PB_thickness"        value="3.1*mm" />
    <constant name="SH_PB_width"            value="TOFEndcap_baseplate_width/2" />
    <constant name="SH_PB_offset"           value="0.0*mm" />
    <constant name="SH_PB_length"           value="TOFEndcap_baseplate_length" />

  </define>

  <documentation>
    ## Forward TOF double-disks
  </documentation>

  <comment>
    Actual detector implementation.
  </comment>
  <define>

    <constant name="TOFEndcapMod_thickness"     value="TOFEndcapSensor_thickness + TOFEndcapService_thickness" />
    <constant name="TOFEndcapMod_angle"         value="360.0*degree / TOFEndcapMod_count * (1 + TOFEndcapMod_overlap)" />
    <comment> 1 um padding to not have layer and module touch (ACTS requirement) </comment>
    <constant name="TOFEndcapLayer_thickness"   value="TOFEndcapMod_thickness + 2 * TOFEndcapMod_dz + 1 * um" />

    <constant name="ForwardTOFMod_rmin"         value="ForwardTOFRegion_minR+5.0*mm" />
    <constant name="ForwardTOFMod_rmax"         value="ForwardTOFRegion_maxR" />
    <constant name="ForwardTOFMod1_zmin"        value="ForwardTOF_zmin" />
    <constant name="ForwardTOFMod2_zmin"        value="ForwardTOF_zmin + ForwardTOFMod_offset" />
    <constant name="ForwardTOFLayer_rmin"       value="ForwardTOFMod_rmin - 1*um" />
    <constant name="ForwardTOFLayer_rmax"       value="ForwardTOFMod_rmax + 1*um" />
    <constant name="ForwardTOFLayer1_zmin"      value="ForwardTOFMod1_zmin - TOFEndcapLayer_thickness / 2" />
    <constant name="ForwardTOFLayer2_zmin"      value="ForwardTOFMod2_zmin - TOFEndcapLayer_thickness / 2" />

    <constant name="ForwardTOFMod_x1"           value="2 * ForwardTOFMod_rmin * tan(TOFEndcapMod_angle/2)" />
    <constant name="ForwardTOFMod_x2"           value="2 * ForwardTOFMod_rmax * sin(TOFEndcapMod_angle/2)" />
    <constant name="ForwardTOFMod_y"            value="ForwardTOFMod_rmax * cos(TOFEndcapMod_angle/2) - ForwardTOFMod_rmin" />

   <constant name="EndcapTOF_Sensor_thickness"       value="0.3*mm"/>
    <constant name="EndcapTOF_Hybrid_thickness"       value="0.008125*cm"/>
    <constant name="EndcapTOF_HybridTrace_thickness"       value="0.002500*cm"/>
    <constant name="EndcapTOF_HybridPCB_thickness"       value="0.1*cm"/>
    <constant name="EndcapTOF_CFSkin_thickness"       value="2*0.0075*cm"/>
    <constant name="EndcapTOF_CFSupp_thickness"        value="0.4*cm"/>
    <constant name="EndcapTOF_CFoam_thickness"        value="2*0.29*cm"/>
    <constant name="EndcapTOF_CHoneycomb_thickness"   value="2*0.29*cm"/>
    <constant name="EndcapTOF_CoolingTube_thickness"  value="0.08*cm"/>
    <constant name="EndcapTOF_Coolant_thickness"      value="0.08*cm"/>
    <constant name="EndcapTOF_Module_thickness"       value="EndcapTOF_Sensor_thickness+2*EndcapTOF_Hybrid_thickness+2*EndcapTOF_CFSkin_thickness+EndcapTOF_CFoam_thickness+EndcapTOF_CoolingTube_thickness+EndcapTOF_Coolant_thickness"/>

    <constant name="EndcapTOF_zOffset"                 value="0*cm"/>
    <constant name="EndcapTOF_radius_design"           value="64.6*cm"/>
    <constant name="EndcapTOF_Module_width_design"     value="53.5*mm"/>
    <constant name="EndcapTOF_Module_length_design"    value="53.5*mm / 2"/>
    <constant name="EndcapTOF_Module_overlap_design"   value="3*mm"/>
    <constant name="EndcapTOF_Module_spacing_design"   value="0.5*mm"/>
    <constant name="EndcapTOF_Sensor_width_design"     value="53 *mm"/>
    <constant name="EndcapTOF_Sensor_length_design"    value="53 *mm / 2"/>
    <constant name="EndcapTOF_CFoam_width_design"      value="EndcapTOF_Sensor_width_design-5.0*mm"/>
    <constant name="EndcapTOF_CHoneycomb_width_design" value="EndcapTOF_Module_width_design-EndcapTOF_CFoam_width_design"/>
    <constant name="EndcapTOF_CoolingTube_width_design" value="0.75*cm"/>
    <constant name="EndcapTOF_Coolant_width_design"    value="0.75*cm"/>

    <constant name="EndcapTOF_Sensor_position_design"  value="0.5*(EndcapTOF_Sensor_width_design-EndcapTOF_Module_width_design)"/>
    <constant name="EndcapTOF_CFoam_position_design"   value="0.5*(EndcapTOF_CFoam_width_design-EndcapTOF_Module_width_design)"/>
    <constant name="EndcapTOF_CHoneycomb_position_design"  value="0.5*(EndcapTOF_Module_width_design-EndcapTOF_CHoneycomb_width_design)"/>
    <constant name="EndcapTOF_CoolingTube_position_design"  value="EndcapTOF_CHoneycomb_position_design"/>
    <constant name="EndcapTOF_Coolant_position_design" value="EndcapTOF_CHoneycomb_position_design"/>
    <constant name="EndcapTOF_Service_position_design" value="0.0*mm"/>

    <constant name="EndcapTOF_scale"               value="1.0"/>
    <constant name="EndcapTOF_radius"              value="EndcapTOF_scale * EndcapTOF_radius_design"/>
    <constant name="EndcapTOF_Sensor_width"        value="EndcapTOF_scale * EndcapTOF_Sensor_width_design"/>
    <constant name="EndcapTOF_Sensor_length"        value="EndcapTOF_scale * EndcapTOF_Sensor_length_design"/>
    <constant name="EndcapTOF_CFoam_width"         value="EndcapTOF_scale * EndcapTOF_CFoam_width_design"/>
    <constant name="EndcapTOF_CHoneycomb_width"    value="EndcapTOF_scale * EndcapTOF_CHoneycomb_width_design"/>
    <constant name="EndcapTOF_CoolingTube_width"   value="EndcapTOF_scale * EndcapTOF_CoolingTube_width_design"/>
    <constant name="EndcapTOF_Coolant_width"       value="EndcapTOF_scale * EndcapTOF_Coolant_width_design"/>
    <constant name="EndcapTOF_Sensor_position"     value="EndcapTOF_scale * EndcapTOF_Sensor_position_design"/>
    <constant name="EndcapTOF_CFoam_position"      value="EndcapTOF_scale * EndcapTOF_CFoam_position_design"/>
    <constant name="EndcapTOF_CHoneycomb_position" value="EndcapTOF_scale * EndcapTOF_CHoneycomb_position_design"/>
    <constant name="EndcapTOF_CoolingTube_position" value="EndcapTOF_scale * EndcapTOF_CoolingTube_position_design"/>
    <constant name="EndcapTOF_Coolant_position"    value="EndcapTOF_scale * EndcapTOF_Coolant_position_design"/>
    <constant name="EndcapTOF_Service_position"    value="EndcapTOF_scale * EndcapTOF_Service_position_design"/>
    <constant name="EndcapTOF_Module_width"        value="EndcapTOF_scale*EndcapTOF_Module_width_design"/>
    <constant name="EndcapTOF_Module_length"        value="EndcapTOF_scale*EndcapTOF_Module_length_design"/>
    <constant name="EndcapTOF_Module_overlap"        value="EndcapTOF_scale*EndcapTOF_Module_overlap_design"/>
    <constant name="EndcapTOF_Module_spacing"        value="EndcapTOF_scale*EndcapTOF_Module_spacing_design"/>
    <constant name="EndcapTOF_Module_tiltangle"    value="20*degree"/>
    <constant name="EndcapTOF_Module_nphi"         value="144"/>
    <constant name="EndcapTOF_Module_nz"           value="1"/>

    <constant name="EndcapTOF_rOffset1"            value="1.6*cm"/>
    <constant name="EndcapTOF_rOffset2"            value="1.4*cm"/>
    <constant name="EndcapTOF_rmin"                value="EndcapTOF_radius-EndcapTOF_rOffset1"/>
    <constant name="EndcapTOF_rmax"                value="EndcapTOF_radius+EndcapTOF_rOffset2"/>
    <constant name="EndcapTOF_length1"             value="80 * cm"/>
    <constant name="EndcapTOF_length2"             value="EndcapTOF_length1"/>
    <constant name="EndcapTOF_length"              value="EndcapTOF_length2"/>


  </define>

  <detectors>
    <detector
      id="BackwardTOF_ID"
      name="BackwardTOF"
      type="epic_CompositeTracker"
      actsType="endcap"
      vis="TrackerSubAssemblyVis">
      <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
      <position x="0*cm" y="0*cm" z="-1*um" />
    </detector>
    <detector
      id="ForwardTOF_ID"
      name="ForwardTOF"
      actsType="endcap"
      type="epic_TOFEndcap"
      readout="TOFEndcapHits"
      vis="TOFVis"
      reflect="false">
      <type_flags type="DetType_TRACKER + DetType_ENDCAP"/>
      <position x="0*cm" y="0*cm" z="ForwardTOF_zmin" />
      <moduleFront name="EndcapTOF_Module1" vis="TOFEndcapModuleVis">
        <module_component name="hybridkaptontop" material="Kapton" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_Hybrid_thickness" vis="TOFHybridVis" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
        <module_component name="hybridPCB" material="Fr4" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_HybridPCB_thickness" vis="AnlGreen" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
        <module_component name="hybridtraces" material="Aluminum" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_HybridTrace_thickness" vis="TOFCFoamVis" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
        <module_component name="hybridkaptonbottom" material="Kapton" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_Hybrid_thickness" vis="TOFHybridVis" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
        <module_component name="sensor" material="Silicon" sensitive="true" width="EndcapTOF_Sensor_width" length="EndcapTOF_Sensor_length" thickness="EndcapTOF_Sensor_thickness" vis="TOFSensorVis" >
          <position x="EndcapTOF_Sensor_position" y="0" z="0" />
        </module_component>
        <module_component name="carbonsupport" material="CarbonFiber" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_CFSupp_thickness" vis="AnlGray" >
          <position x="EndcapTOF_Sensor_position" y="0" z="0" />
        </module_component>
      </moduleFront>
      <moduleBack name="EndcapTOF_Module1" vis="TOFEndcapModuleVis">
        <module_component name="carbonsupport" material="CarbonFiber" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_CFSupp_thickness" vis="AnlGray" >
          <position x="EndcapTOF_Sensor_position" y="0" z="0" />
        </module_component>
        <module_component name="sensor" material="Silicon" sensitive="true" width="EndcapTOF_Sensor_width" length="EndcapTOF_Sensor_length" thickness="EndcapTOF_Sensor_thickness" vis="TOFSensorVis" >
          <position x="EndcapTOF_Sensor_position" y="0" z="0" />
        </module_component>
        <module_component name="hybridkaptonbottom" material="Kapton" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_Hybrid_thickness" vis="TOFHybridVis" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
        <module_component name="hybridtraces" material="Aluminum" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_HybridTrace_thickness" vis="TOFCFoamVis" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
        <module_component name="hybridPCB" material="Fr4" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_HybridPCB_thickness" vis="AnlGreen" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
        <module_component name="hybridkaptontop" material="Kapton" sensitive="false" width="EndcapTOF_Module_width" length="EndcapTOF_Module_length" thickness="EndcapTOF_Hybrid_thickness" vis="TOFHybridVis" >
          <position x="EndcapTOF_Service_position" y="0" z="0" />
        </module_component>
      </moduleBack>
      <layer module="EndcapTOF_Module1" id="1">
        <envelope vis="TOF_envelope"
          rmin="ForwardTOFLayer_rmin"
          rmax="ForwardTOFLayer_rmax"
          length="3*cm"
          zstart="ForwardTOF_zmin" />
        <layer_material surface="inner" binning="binPhi,binR" bins0="256" bins1="256"/>
        <y_layout dr="0.0*mm" z0="EndcapTOF_zOffset" nz="EndcapTOF_Module_nz"/>
        <z_layout z0="ForwardTOF_zmin"/>
      </layer>
      <support module="EndcapTOF_SupportDummy" id="1" vis="InvisibleWithDaughters">
        <envelope vis="AnlGray"
          rmin="ForwardTOFLayer_rmin"
          rmax="ForwardTOFLayer_rmax"
          length="12*mm"
          zstart="ForwardTOF_zmin" />
      </support>
      <modsize
          width="EndcapTOF_Module_width"
          length="EndcapTOF_Module_length"
          overlap="EndcapTOF_Module_overlap"
          spacing="EndcapTOF_Module_spacing" />
    </detector>
  </detectors>

  <plugins>
    <plugin name="DD4hep_ParametersPlugin">
      <argument value="ForwardTOF"/>
      <argument value="layer_pattern: str=ForwardTOF_layer\d"/>
    </plugin>
  </plugins>

  <readouts>
    <readout name="TOFEndcapHits">
      <segmentation type="CartesianGridXY" grid_size_x="0.1*mm" grid_size_y="0.1*cm" />
      <id>system:8,layer:4,module:8,idx:7,idy:5,x:32:-16,y:-16</id>
    </readout>
  </readouts>

</lccdd>
